name: Deploy to VPS

on:
  push:
    branches:
      - master  # Se activa cuando subes algo a la rama main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cinfigure Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Installation y Build üèóÔ∏è
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: |
          npm install
          npm run build  # Aqu√≠ se genera tu carpeta 'dist' o 'build'

      - name: Deploy to VPS via SCP üöÄ
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REM_HST }}
          username: ${{ secrets.USRNM }}
          key: ${{ secrets.SSH_PRIV_KEY }}
          source: "dist/*"
          target: "/var/www/${{ secrets.DIRECTORY_NAME }}/tecnocard/releases/${{ github.sha }}"
          strip_components: 1

      - name: Restart services via SSH üîÑ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REM_HST }}
          username: ${{ secrets.USRNM }}
          key: ${{ secrets.SSH_PRIV_KEY }}
          script: |
            # 1. Definici√≥n de variables con rutas absolutas
            BASE_PATH="/var/www/${{ secrets.DIRECTORY_NAME }}/tecnocard"
            CURRENT_LINK="$BASE_PATH/current"
            NEW_RELEASE="$BASE_PATH/releases/${{ github.sha }}"
            
            # 2. Guardar backup del estado actual (punto de restauraci√≥n)
            # Si el link no existe (primer deploy), fallar√° silenciosamente el readlink
            BACKUP_RELEASE=$(readlink -f $CURRENT_LINK || echo "")

            echo "Ajustando permisos de la nueva versi√≥n..."
            # Aseguramos que el grupo sea www-data y tenga permisos de lectura
            sudo chown -R ${{ secrets.USRNM }}:www-data "$NEW_RELEASE"
            sudo chmod -R 775 "$NEW_RELEASE"

            echo "Actualizando enlace simb√≥lico: $CURRENT_LINK -> $NEW_RELEASE"
            # ln -sfnv: v para ver el cambio exacto en los logs
            sudo ln -sfnv "$NEW_RELEASE" "$CURRENT_LINK"

            # 3. Validaci√≥n y reinicio
            if sudo nginx -t; then
              echo "‚úÖ Validaci√≥n de Nginx exitosa. Reiniciando..."
              sudo systemctl restart nginx
              
              # Limpieza: mantener solo las √∫ltimas 5 versiones para ahorrar espacio
              echo "Limpiando releases antiguas..."
              cd "$BASE_PATH/releases" && ls -t | tail -n +6 | xargs rm -rf --
            else
              echo "‚ùå ERROR en la nueva versi√≥n. Iniciando Rollback..."
              if [ -n "$BACKUP_RELEASE" ]; then
                sudo ln -sfnv "$BACKUP_RELEASE" "$CURRENT_LINK"
                echo "Restaurado a la versi√≥n: $BACKUP_RELEASE"
              fi
              # Eliminamos la versi√≥n fallida para evitar acumulaciones corruptas
              sudo rm -rf "$NEW_RELEASE"
              exit 1
            fi
